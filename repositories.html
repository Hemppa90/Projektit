<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <title>Repositories</title>
    <link rel="stylesheet" type="text/css" href="repositories_style.css" />
  </head>
  <body>

    <div id="container">
      <div id="contentpane" style="overflow-y:auto;">
        <table id="content"></table>
      </div>
      <div id="contentpane2" style="overflow-y:auto;">
        <table id="content2"></table>
      </div>
    </div>

    <div id="container2">
      <input type="text" id="input_field_1" placeholder="Type a user..." />
      <button id="fetch_repos_button">Fetch Repos</button>
    </div>

    <script>

      //const client_id = "b857f54d00ac16a4ea81";
      //const client_secret = "305eec1bd5abd97479198132157528b09c1b211b";

      //haetaan muuttujiin html-elementeistä syötelenttä ja hakupainike.
      const userValue = document.querySelector("#input_field_1");
      const fetchReposButton = document.querySelector("#fetch_repos_button");

      //alustetaan apumuuttujat, joihin tullaan myöhemmin asettamaan käyttäjän ja repositoryjen nimet.
      var name;
      var repo;

      //tämä funktio tekee api-kutsun annetulla käyttäjän nimellä ja esittää repositoryt 
      //painikkeina taulukossa.
      function fetchRepos(user)
      {

        clearRepoResults();
        var request = new XMLHttpRequest();
        request.open('GET', 'https://api.github.com/users/' + user + '/repos', true);

        request.onload = function()
        {
          var data = JSON.parse(this.response);

          for(i = 0; i < data.length; i++)
          {
            var table = document.getElementById("content");
            var row = table.insertRow(-1);
            var cell = row.insertCell(0);
            var child = document.createElement("div");
            child.textContent = data[i].name;

            child.addEventListener("click", function()
            {
              fetchCommits(this.textContent);
            });

            cell.appendChild(child);
            cell.id = "repo_cell";
          }
        }
        request.send();
      }

      //tämä funktio tekee api-kutsun annetulla repositoryn nimellä ja noutaa sen commitit taulukkoon.
      //For-luupissa noudetaan kymmenen viimeisintä committia ja niistä authorin nimi,
      //avatar-kuva, ajankohta ja commit-viesti. Luuppi erottelee myös kuvalliset ja
      //ei-kuvalliset commitit. 
      function fetchCommits(repo)
      {

        clearCommitResults();
        var request = new XMLHttpRequest();
        request.open('GET', 'https://api.github.com/repos/' + name + '/' + repo + '/commits', true);

        request.onload = function()
        {
          var data = JSON.parse(this.response);
          
          for(i = 0; i < 10; i++)
          {
            if(data[i].author == null)
            {
              console.log(data[i]);
              console.log(data[i].commit.author.name + " " + 
                          data[i].commit.author.date + " " +
                          data[i].commit.message);

              var table = document.getElementById("content2");
              var row = table.insertRow(-1);
              var cell = row.insertCell(0);
              var child = document.createElement("div");

              child.textContent = repo + " | " + "Commit " + (i+1) + "\n" + 
                                  "Author Name: " + data[i].commit.author.name + "\n" + 
                                  "Author Date: " + data[i].commit.author.date + "\n" + 
                                  "Message: "     + data[i].commit.message + "\n";
        
              cell.appendChild(child);
              cell.id = "commit_cell";
            }
            else
            {
              console.log(data[i]);
              console.log(data[i].commit.author.name + " " + 
                          data[i].commit.author.date + " " + 
                          data[i].commit.message + " " + 
                          data[i].author.avatar_url);

              var table = document.getElementById("content2");
              var row = table.insertRow(-1);
              var cell = row.insertCell(0);
              var child = document.createElement("div");

              child.textContent = repo + " | " + "Commit " + (i+1) + "\n" + 
                                  "Author Name: " + data[i].commit.author.name + "\n" + 
                                  "Author Date: " + data[i].commit.author.date + "\n" + 
                                  "Message: "     + data[i].commit.message + "\n";
              
              var img = document.createElement("img");
              img.height = 200;
              img.width = 200;
              img.src = data[i].author.avatar_url;
              cell.appendChild(img);

              cell.appendChild(child);
              cell.id = "commit_cell";
            }
          }
        }
        request.send();
      }

      //tällä funktiolla tyhjennetään repositorypainikkeet taulukosta.
      function clearRepoResults()
      {
        var table = document.getElementById("content");
        table.innerHTML = '';
      }

      //tällä funktiolla tyhjennetään listatut commitit taulukosta.
      function clearCommitResults()
      {
        var table = document.getElementById("content2");
        table.innerHTML = '';
      }

      //tässä liitetään repositoryjen hakupainikkeelle klikinkuuntelija.
      //syötekentän käyttäjä asetetaan apumuuttujaan ja sillä laukaistaan
      //repositoryjen noutofunktio.
      fetchReposButton.addEventListener("click", () => 
      {
        name = userValue.value;
        fetchRepos(name);
      })

    </script>

  </body>
</html>
